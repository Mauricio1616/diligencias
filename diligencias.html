<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Diligencias Diarias (Colaborativo)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Un verde claro más suave para el fondo general */
        }
        .main-container {
            background-color: #dcfce7; /* El verde claro principal para la tabla */
        }
        .observacion-col {
            background-color: #fed7aa; /* Naranja */
        }
        .pendiente-col {
            background-color: #fef08a; /* Amarillo */
        }
        .total-mensual-cell {
            background-color: #166534; /* Verde oscuro */
            color: white;
            font-weight: bold;
        }
        /* Ocultar flechas en input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .table-responsive > table {
            width: max-content;
            min-width: 100%;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <!-- Encabezado -->
        <header class="text-center mb-6">
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-green-800">DILIGENCIAS DIARIAS (COLABORATIVO)</h1>
             <p class="text-sm text-gray-500 mt-2">ID de Sesión: <span id="user-id" class="font-mono">Cargando...</span></p>
            <div class="flex items-center justify-center space-x-4 mt-4">
                <button id="prev-month" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">‹ Mes Anterior</button>
                <h2 id="month-year-display" class="text-2xl font-semibold text-green-700 w-64 text-center"></h2>
                <button id="next-month" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Mes Siguiente ›</button>
            </div>
        </header>
        
        <div id="loading" class="text-center">
             <div class="loader"></div>
             <p class="text-green-700">Conectando a la base de datos en tiempo real...</p>
        </div>

        <!-- Contenedor del Calendario/Tabla -->
        <main id="calendar-container" class="space-y-6 hidden"></main>

        <!-- Pie de página con Total Mensual -->
        <footer class="mt-8 flex justify-end">
            <div class="total-mensual-cell p-4 rounded-lg shadow-lg">
                <span class="text-xl">Total Mensual:</span>
                <span id="monthly-total" class="text-2xl ml-2">Bs 0.00</span>
            </div>
        </footer>
    </div>

    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, updateDoc, query, where, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-diligencias-app';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        document.addEventListener('DOMContentLoaded', () => {
            const diligenciasApp = {
                // Estado de la aplicación
                state: {
                    currentDate: new Date(2025, 8, 1),
                    diligencias: {}, // { 'YYYY-MM-DD': [ { id, cliente, ... } ] }
                    userId: null,
                    unsubscribe: null, // To detach the Firestore listener
                },

                // Elementos del DOM
                elements: {
                    monthYearDisplay: document.getElementById('month-year-display'),
                    calendarContainer: document.getElementById('calendar-container'),
                    monthlyTotal: document.getElementById('monthly-total'),
                    prevMonthBtn: document.getElementById('prev-month'),
                    nextMonthBtn: document.getElementById('next-month'),
                    userIdDisplay: document.getElementById('user-id'),
                    loadingIndicator: document.getElementById('loading'),
                },

                // Inicializador
                async init() {
                    this.attachEventListeners();
                    await this.handleAuthentication();
                },

                async handleAuthentication() {
                     onAuthStateChanged(auth, user => {
                        if (user) {
                            this.state.userId = user.uid;
                            this.elements.userIdDisplay.textContent = this.state.userId;
                            console.log("Authenticated with user ID:", this.state.userId);
                            this.fetchData();
                        }
                    });

                    if (auth.currentUser) {
                         this.state.userId = auth.currentUser.uid;
                         this.elements.userIdDisplay.textContent = this.state.userId;
                         console.log("Already authenticated with user ID:", this.state.userId);
                         this.fetchData();
                    } else if (typeof __initial_auth_token !== 'undefined') {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                },

                fetchData() {
                    // Detach any previous listener
                    if (this.state.unsubscribe) {
                        this.state.unsubscribe();
                    }
                    
                    this.elements.loadingIndicator.classList.remove('hidden');
                    this.elements.calendarContainer.classList.add('hidden');
                    this.state.diligencias = {}; // Clear local cache
                    this.render(); // Render empty shell

                    const year = this.state.currentDate.getFullYear();
                    const month = this.state.currentDate.getMonth() + 1;
                    const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                    
                    const diligenciasCollection = collection(db, `/artifacts/${appId}/public/data/diligencias`);
                    const q = query(diligenciasCollection, where("monthKey", "==", monthKey));
                    
                    this.state.unsubscribe = onSnapshot(q, (querySnapshot) => {
                        console.log("Received real-time update from Firestore");
                        const allDiligencias = [];
                        querySnapshot.forEach((doc) => {
                            allDiligencias.push({ firestoreId: doc.id, ...doc.data() });
                        });
                        
                        // Group by dateKey
                        this.state.diligencias = allDiligencias.reduce((acc, d) => {
                            if (!acc[d.dateKey]) {
                                acc[d.dateKey] = [];
                            }
                            acc[d.dateKey].push(d);
                            return acc;
                        }, {});

                        this.render();
                        this.elements.loadingIndicator.classList.add('hidden');
                        this.elements.calendarContainer.classList.remove('hidden');

                    }, (error) => {
                        console.error("Error fetching data from Firestore: ", error);
                        alert("No se pudo conectar a la base de datos. Por favor, revisa la conexión o la configuración.");
                        this.elements.loadingIndicator.textContent = 'Error de conexión.';
                    });
                },

                render() {
                    this.renderHeader();
                    this.renderCalendar();
                    this.updateMonthlyTotal();
                },

                renderHeader() {
                    const monthName = this.state.currentDate.toLocaleString('es-ES', { month: 'long' }).toUpperCase();
                    this.elements.monthYearDisplay.textContent = `${monthName} ${this.state.currentDate.getFullYear()}`;
                },
                
                renderCalendar() {
                    this.elements.calendarContainer.innerHTML = '';
                    const year = this.state.currentDate.getFullYear();
                    const month = this.state.currentDate.getMonth();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const dateString = `${String(day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`;
                        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        
                        const dayContainer = document.createElement('div');
                        dayContainer.className = 'main-container p-4 rounded-lg shadow-md';
                        dayContainer.id = `day-${dateKey}`;
                        
                        dayContainer.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-green-800">${dateString} - ${date.toLocaleDateString('es-ES', { weekday: 'long' })}</h3>
                                <button data-date="${dateKey}" class="add-diligencia-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105">+ Añadir Diligencia</button>
                            </div>
                            <div class="table-responsive">
                                <table class="min-w-full bg-white rounded-md overflow-hidden">
                                    <thead class="bg-green-700 text-white">
                                        <tr>
                                            ${['CLIENTE', 'TRÁMITE', 'LUGAR', 'ESTADO', 'OBSERVACIÓN', 'PENDIENTE', 'GASTO', 'MONTO', 'PROCURADOR', 'ABOGADO', 'ACCIÓN'].map(h => `<th class="py-2 px-3 text-left text-sm font-semibold">${h}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-${dateKey}"></tbody>
                                    <tfoot class="font-bold">
                                        <tr>
                                            <td colspan="7" class="text-right py-2 px-3 border-t-2 border-green-300">Total Diario:</td>
                                            <td id="total-diario-${dateKey}" class="py-2 px-3 border-t-2 border-green-300 text-green-800" colspan="4">Bs 0.00</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        `;
                        this.elements.calendarContainer.appendChild(dayContainer);
                        
                        const tbody = document.getElementById(`tbody-${dateKey}`);
                        const diligenciasDelDia = this.state.diligencias[dateKey] || [];
                        diligenciasDelDia.forEach(d => tbody.appendChild(this.createDiligenciaRow(d)));
                        
                        this.updateDailyTotal(dateKey);
                    }
                },

                createDiligenciaRow(diligencia) {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.dataset.id = diligencia.firestoreId;

                    const estadoOptions = ["EN PROCESO", "COMPLETADO", "SIN SALIDA", "NOTIFICACIÓN", "FECHA DE AUDIENCIA", "OBSERVADO"];
                    const procuradorOptions = ["MARIELA", "CECILIA", "MARICELA", "VALERIA"];
                    const gastoOptions = ["FOTOCOPIAS", "PASAJE", "PAGO DILIGENCIAS"];

                    row.innerHTML = `
                        <td class="p-2"><input type="text" data-field="cliente" value="${diligencia.cliente || ''}" class="w-full p-1 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500"></td>
                        <td class="p-2"><input type="text" data-field="tramite" value="${diligencia.tramite || ''}" class="w-full p-1 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500"></td>
                        <td class="p-2"><input type="text" data-field="lugar" value="${diligencia.lugar || ''}" class="w-full p-1 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500"></td>
                        <td class="p-2">
                            <select data-field="estado" class="w-full p-1 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500">
                                ${estadoOptions.map(o => `<option value="${o}" ${diligencia.estado === o ? 'selected' : ''}>${o}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-2 observacion-col"><textarea data-field="observacion" class="w-full p-1 border rounded bg-orange-50 focus:outline-none focus:ring-2 focus:ring-orange-500 h-16">${diligencia.observacion || ''}</textarea></td>
                        <td class="p-2 pendiente-col"><textarea data-field="pendiente" class="w-full p-1 border rounded bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-yellow-500 h-16">${diligencia.pendiente || ''}</textarea></td>
                        <td class="p-2">
                            <div class="space-y-1">
                                ${gastoOptions.map(g => `<label class="flex items-center text-sm"><input type="checkbox" data-field="gasto" value="${g}" class="mr-1 h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500" ${diligencia.gasto && diligencia.gasto.includes(g) ? 'checked' : ''}> ${g}</label>`).join('')}
                                <div class="flex items-center text-sm"><input type="checkbox" data-field="gasto" value="OTROS" class="gasto-otros-check mr-1 h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500" ${diligencia.gasto && diligencia.gasto.includes('OTROS') ? 'checked' : ''}> OTROS</div>
                                <input type="text" data-field="gasto_otros_texto" placeholder="Especificar..." value="${diligencia.gasto_otros_texto || ''}" class="w-full p-1 border rounded bg-gray-50 text-sm mt-1 focus:outline-none focus:ring-2 focus:ring-green-500 ${diligencia.gasto && diligencia.gasto.includes('OTROS') ? '' : 'hidden'}">
                            </div>
                        </td>
                        <td class="p-2">
                           <div class="flex items-center">
                               <input type="number" data-field="monto" value="${diligencia.monto || ''}" step="0.01" class="w-24 p-1 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500">
                               <select data-field="moneda" class="ml-1 p-1 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option value="Bs" ${diligencia.moneda === 'Bs' ? 'selected' : ''}>Bs</option>
                                    <option value="$" ${diligencia.moneda === '$' ? 'selected' : ''}>$</option>
                                </select>
                           </div>
                        </td>
                        <td class="p-2">
                            <select data-field="procurador" class="procurador-select w-full p-1 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500">
                                ${procuradorOptions.map(p => `<option value="${p}" ${diligencia.procurador === p ? 'selected' : ''}>${p}</option>`).join('')}
                                <option value="OTROS" ${diligencia.procurador === 'OTROS' || (diligencia.procurador && !procuradorOptions.includes(diligencia.procurador)) ? 'selected' : ''}>OTROS</option>
                            </select>
                            <input type="text" data-field="procurador_otro" value="${diligencia.procurador_otro || ''}" class="w-full p-1 border rounded bg-gray-50 mt-1 focus:outline-none focus:ring-2 focus:ring-green-500 ${diligencia.procurador === 'OTROS' || (diligencia.procurador && !procuradorOptions.includes(diligencia.procurador)) ? '' : 'hidden'}">
                        </td>
                        <td class="p-2"><input type="text" data-field="abogado" value="${diligencia.abogado || ''}" class="w-full p-1 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500"></td>
                        <td class="p-2 align-middle text-center"><button class="delete-diligencia-btn text-red-500 hover:text-red-700 font-bold text-2xl" title="Eliminar Diligencia">&times;</button></td>
                    `;
                    return row;
                },
                
                attachEventListeners() {
                    this.elements.prevMonthBtn.addEventListener('click', () => {
                        this.state.currentDate.setMonth(this.state.currentDate.getMonth() - 1);
                        this.fetchData();
                    });
                    this.elements.nextMonthBtn.addEventListener('click', () => {
                        this.state.currentDate.setMonth(this.state.currentDate.getMonth() + 1);
                        this.fetchData();
                    });
                    
                    this.elements.calendarContainer.addEventListener('click', e => {
                        if (e.target.classList.contains('add-diligencia-btn')) this.addDiligencia(e.target.dataset.date);
                        if (e.target.classList.contains('delete-diligencia-btn')) this.deleteDiligencia(e.target.closest('tr').dataset.id);
                    });

                    const debounce = (func, delay) => {
                        let timeout;
                        return function(...args) {
                            clearTimeout(timeout);
                            timeout = setTimeout(() => func.apply(this, args), delay);
                        };
                    };
                    const debouncedUpdate = debounce((id, field, value) => this.updateDiligencia(id, { [field]: value }), 500);

                    this.elements.calendarContainer.addEventListener('input', e => {
                        const row = e.target.closest('tr');
                        if (!row) return;
                        const id = row.dataset.id;
                        const field = e.target.dataset.field;
                        debouncedUpdate(id, field, e.target.value);
                    });

                    this.elements.calendarContainer.addEventListener('change', e => {
                        const row = e.target.closest('tr');
                        if (!row) return;
                        const id = row.dataset.id;
                        const field = e.target.dataset.field;
                        
                        if (field === 'gasto') {
                            const checkboxes = row.querySelectorAll('input[type="checkbox"][data-field="gasto"]');
                            const value = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
                            this.updateDiligencia(id, { [field]: value });
                            const textInput = row.querySelector('[data-field="gasto_otros_texto"]');
                            textInput.classList.toggle('hidden', !value.includes('OTROS'));
                        } else {
                            this.updateDiligencia(id, { [field]: e.target.value });
                        }
                        
                        if (e.target.classList.contains('procurador-select')) {
                             const textInput = e.target.nextElementSibling;
                            textInput.classList.toggle('hidden', e.target.value !== 'OTROS');
                        }
                    });
                },
                
                async addDiligencia(dateKey) {
                    const monthKey = dateKey.substring(0, 7);
                    const newDiligencia = { 
                        dateKey, 
                        monthKey,
                        estado: 'EN PROCESO',
                        createdAt: new Date().toISOString(),
                        createdBy: this.state.userId,
                     };
                    try {
                        const docRef = await addDoc(collection(db, `/artifacts/${appId}/public/data/diligencias`), newDiligencia);
                        console.log("Document written with ID: ", docRef.id);
                    } catch (e) {
                        console.error("Error adding document: ", e);
                    }
                },
                
                async deleteDiligencia(firestoreId) {
                    if (confirm('¿Estás seguro de que quieres eliminar esta diligencia?')) {
                        try {
                            await deleteDoc(doc(db, `/artifacts/${appId}/public/data/diligencias`, firestoreId));
                            console.log("Document successfully deleted!");
                        } catch (error) {
                             console.error("Error removing document: ", error);
                        }
                    }
                },
                
                async updateDiligencia(firestoreId, dataToUpdate) {
                     try {
                        const docRef = doc(db, `/artifacts/${appId}/public/data/diligencias`, firestoreId);
                        await updateDoc(docRef, dataToUpdate);
                     } catch(error) {
                        console.error("Error updating document: ", error);
                     }
                },

                updateDailyTotal(dateKey) {
                    const totalDiarioCell = document.getElementById(`total-diario-${dateKey}`);
                    if (!totalDiarioCell) return;
                    
                    const diligenciasDelDia = this.state.diligencias[dateKey] || [];
                    const totalBs = diligenciasDelDia.filter(d => d.moneda === 'Bs' || !d.moneda).reduce((sum, d) => sum + (parseFloat(d.monto) || 0), 0);
                    const totalUsd = diligenciasDelDia.filter(d => d.moneda === '$').reduce((sum, d) => sum + (parseFloat(d.monto) || 0), 0);
                        
                    let totalText = [];
                    if (totalBs > 0) totalText.push(`Bs ${totalBs.toFixed(2)}`);
                    if (totalUsd > 0) totalText.push(`$ ${totalUsd.toFixed(2)}`);
                    totalDiarioCell.textContent = totalText.join(' + ') || 'Bs 0.00';
                },

                updateMonthlyTotal() {
                    let totalBs = 0;
                    let totalUsd = 0;
                    for (const dateKey in this.state.diligencias) {
                        this.state.diligencias[dateKey].forEach(d => {
                            const monto = parseFloat(d.monto) || 0;
                            if (d.moneda === '$') totalUsd += monto;
                            else totalBs += monto;
                        });
                    }
                    let totalText = [];
                    if (totalBs > 0) totalText.push(`Bs ${totalBs.toFixed(2)}`);
                    if (totalUsd > 0) totalText.push(`$ ${totalUsd.toFixed(2)}`);
                    this.elements.monthlyTotal.textContent = totalText.join(' + ') || 'Bs 0.00';
                }
            };

            diligenciasApp.init();
        });
    </script>
</body>
</html>
